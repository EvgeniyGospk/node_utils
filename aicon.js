#!/usr/bin/env node

import fs from "fs/promises";
import path from "path";
import yargs from "yargs";
import { hideBin } from "yargs/helpers";

// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---

// !!! –í–ê–ñ–ù–û: –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥ –≤–∞—à –ø—Ä–æ–µ–∫—Ç !!!
// –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø—É—Ç–∏ –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
const ESSENTIAL_FILES = [
  "package.json",
  "nx.json", // –∏–ª–∏ turbo.json, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Turborepo
  "tsconfig.base.json", // –∏–ª–∏ –∫–æ—Ä–Ω–µ–≤–æ–π tsconfig.json
  "apps/backend/tsconfig.app.json", // –ü—Ä–∏–º–µ—Ä
  "apps/frontend/tsconfig.json", // –ü—Ä–∏–º–µ—Ä
  "apps/frontend/vite.config.ts", // –ü—Ä–∏–º–µ—Ä
  "nest-cli.json", // –ü—Ä–∏–º–µ—Ä –¥–ª—è NestJS
  ".eslintrc.js", // –∏–ª–∏ .json, .yaml ...
  ".prettierrc.js", // –∏–ª–∏ .json, .yaml ...
  "Dockerfile", // –ï—Å–ª–∏ –µ—Å—Ç—å –≥–ª–∞–≤–Ω—ã–π
  "docker-compose.yml", // –ï—Å–ª–∏ –µ—Å—Ç—å
  // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –í–ê–ñ–ù–´–ï –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ñ–∞–π–ª—ã!
];

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
const DIRTREE_EXCLUDE_DIRS = ["node_modules", ".git", "dist", "build"]; // –ü–∞–ø–∫–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
const DIRTREE_MAX_DEPTH = 3; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –¥–µ—Ä–µ–≤–∞

// –ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const DEFAULT_OUTPUT_FILENAME = "ai_session_context.md";

// --- –®–ê–ë–õ–û–ù –ü–†–û–ú–ü–¢–ê –î–õ–Ø –ù–û–í–û–ô –°–ï–°–°–ò–ò ---
// (–í–∑—è—Ç –Ω–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
const NEW_SESSION_PROMPT_TEMPLATE = `
# –≠—Ç–∞–ª–æ–Ω–Ω—ã–π –ü—Ä–æ–µ–∫—Ç: –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –°–µ—Å—Å–∏–∏ –∏ –ó–∞–ø—Ä–æ—Å –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ v2 (–ü—Ä–æ–º–ø—Ç –¥–ª—è AI)

**(–í–∞–∂–Ω–æ: –≠—Ç–æ –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –ù–û–í–û–ô —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ –ø–æ–ª–Ω—É—é –ø–æ—Ç–µ—Ä—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI)**

---

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI –Ω–∞ –≠—Ç—É –°–µ—Å—Å–∏—é:**

–ü—Ä–∏–≤–µ—Ç! –ú—ã –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –Ω–∞—à–∏–º **—ç—Ç–∞–ª–æ–Ω–Ω—ã–º full-stack –ø—Ä–æ–µ–∫—Ç–æ–º**.

**–¢–≤–æ—è –†–æ–ª—å –≤ –≠—Ç–æ–π –°–µ—Å—Å–∏–∏:** –¢—ã ‚Äî **–≥–ª–∞–≤–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, –≤–µ–¥—É—â–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ü–û –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫** —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –Ø ‚Äî —Ç–≤–æ–π –∑–∞–∫–∞–∑—á–∏–∫ –∏ –º–ª–∞–¥—à–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ—Å—Ç–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Å–ª–µ–¥—É—è –≤—ã—Å–æ—á–∞–π—à–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.

**–ù–∞—à–∞ –¶–µ–ª—å ("–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –≠—Ç–∞–ª–æ–Ω"):** –ú—ã —Å–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—Ü–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (React/Node.js), —Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—è—Å—å: SOLID, DDD, –ß–∏—Å—Ç–æ–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã/–ì–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π, FSD (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥), —Å—Ç—Ä–æ–≥–∏–π TypeScript, –ø–µ—Ä–µ–¥–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (NestJS, Prisma, GraphQL –∏ —Ç.–¥.), –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, DevOps, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (ADRs!). –¢—ã –¥–æ–ª–∂–µ–Ω —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è —ç—Ç–∏–º–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ –≤–æ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö.

**–ù–∞—à –ú–µ—Ç–æ–¥ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤ –≠—Ç–æ–π –°–µ—Å—Å–∏–∏:**
*   **–¢—ã –í–µ–¥–µ—à—å, –Ø –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é:** –¢—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —à–∞–≥–∏, —Ä–µ—à–µ–Ω–∏—è, –∫–æ–¥, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –Ø –∑–∞–¥–∞—é –≤–æ–ø—Ä–æ—Å—ã –∏ –¥–∞—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (\`–û–ö\`, \`–°–û–ì–õ–ê–°–ï–ù\`, \`–î–ï–õ–ê–ï–ú\`) –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ —Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∏—à—å –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å —á—Ç–æ-—Ç–æ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ.
*   **–ü–æ—à–∞–≥–æ–≤–æ—Å—Ç—å –∏ –§–æ–∫—É—Å:** –î–≤–∏–≥–∞–µ–º—Å—è **–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–º–∏ —ç—Ç–∞–ø–∞–º–∏**. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º—Å—è –Ω–∞ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ –∑–∞ —Ä–∞–∑. –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –º–µ–Ω—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
*   **–ê–∫—Ç–∏–≤–Ω—ã–µ –í–æ–ø—Ä–æ—Å—ã –æ—Ç –¢–µ–±—è:** –¢—ã *–æ–±—è–∑–∞–Ω* –∞–∫—Ç–∏–≤–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –º–Ω–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã *–ø–µ—Ä–µ–¥* –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∫–æ–¥–∞/–∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏–ª–∏ –ø—Ä–∏–Ω—è—Ç–∏–µ–º —Ä–µ—à–µ–Ω–∏–π. –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –ø–ª—é—Å–∞–º–∏/–º–∏–Ω—É—Å–∞–º–∏ –∏ –∂–¥–∏ –º–æ–µ–≥–æ –≤—ã–±–æ—Ä–∞. **–ù–µ –¥–µ–ª–∞–π –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ —è–≤–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è!**
*   **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–µ–º–ø–æ–º:** –Ø –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã \`–ì–û–¢–û–í\`, \`–ü–û–î–†–û–ë–ù–ï–ï\`, \`–ú–ï–î–õ–ï–ù–ù–ï–ï\` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º–ø–æ–º.
*   **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–µ—Å—Å–∏—è–º–∏:** –Ø –∏—Å–ø–æ–ª—å–∑—É—é \`–ü–ê–£–ó–ê –°–ï–°–°–ò–ò\` (–ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –†–µ–∑—é–º–µ) –∏ \`–í–û–ó–û–ë–ù–û–í–ò–¢–¨ –°–ï–°–°–ò–Æ\` (—Å —Ç–≤–æ–∏–º –†–µ–∑—é–º–µ + –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º).
*   **Git –∏ ADRs:** –¢—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∫–æ–º–º–∏—Ç—ã (Conventional Commits) –∏ —Ñ–∏–∫—Å–∞—Ü–∏—é —Ä–µ—à–µ–Ω–∏–π –≤ ADR.
*   **–ü–æ–º–æ—â—å –ø—Ä–∏ –û—à–∏–±–∫–∞—Ö:** –ï—Å–ª–∏ —è —Å–æ–æ–±—â—É –æ–± –æ—à–∏–±–∫–µ, —Ç—ã –ø–æ–º–æ–∂–µ—à—å –µ–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å.
*   **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:** –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å markdown/ASCII –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä.

**–ù–∞—à–∏ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ (\`dirtree\`, \`codescan\`):**
*   –Ø (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã \`dirtree\` –∏ \`codescan\` –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–µ–±–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏ –∫–æ–¥–µ –ø—Ä–æ–µ–∫—Ç–∞, –∫–æ–≥–¥–∞ —Ç—ã –µ–µ –∑–∞–ø—Ä–æ—Å–∏—à—å –∏–ª–∏ –∫–æ–≥–¥–∞ —è –ø–æ—Å—á–∏—Ç–∞—é –Ω—É–∂–Ω—ã–º.
*   **–¢—ã –º–æ–∂–µ—à—å (–∏ –¥–æ–ª–∂–µ–Ω!) –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å** —É –º–µ–Ω—è –≤—ã–≤–æ–¥ —ç—Ç–∏—Ö –∫–æ–º–∞–Ω–¥ —Å **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏**, –∫–æ–≥–¥–∞ —Ç–µ–±–µ –Ω—É–∂–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.
*   **\`dirtree\`:** –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—à—å \`dirtree --dir [–ø—É—Ç—å] --md [–≥–ª—É–±–∏–Ω–∞] ...\`. –Ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –≤—ã–≤–æ–¥ –≤ \`\`\`text –±–ª–æ–∫–µ.
*   **\`codescan\`:** –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ —Ç—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—à—å \`codescan -of [–ò–º—è–§–∞–π–ª–∞1.ts] -of [–ò–º—è–§–∞–π–ª–∞2.ts] ...\` (—É—Ç–æ—á–Ω–∏–≤ –æ–∂–∏–¥–∞–µ–º—ã–π –º–æ–¥—É–ª—å/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å \`-d [–ø—É—Ç—å]\`). –Ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é **–ø–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥** —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ \`--- File: [–ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É] ---\` –≤ \`\`\`[—è–∑—ã–∫] –±–ª–æ–∫–µ.

---

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ü—Ä–æ—à–ª–æ–π –°–µ—Å—Å–∏–∏:**

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–æ **–†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏ (–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –°–Ω–∏–º–æ–∫)**, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—É–∑–æ–π. –û–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –≥–¥–µ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ.

\`\`\`markdown
[!!! –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –ü–û–õ–ù–´–ô –¢–ï–ö–°–¢ "–†–ï–ó–Æ–ú–ï –°–ï–°–°–ò–ò" –° –ü–†–û–®–õ–û–ì–û –†–ê–ó–ê !!!]
\`\`\`

---

**–¢–≤–æ—è –ü–µ—Ä–≤–∞—è –ó–∞–¥–∞—á–∞ –°–µ–π—á–∞—Å (–ó–∞–ø—Ä–æ—Å –ë–∞–∑–æ–≤–æ–≥–æ –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞):**

–†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É, –Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º **–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞**. –¢–≤–æ—è **–ø–µ—Ä–≤–æ–æ—á–µ—Ä–µ–¥–Ω–∞—è –∑–∞–¥–∞—á–∞** ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É –º–µ–Ω—è —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**–ß—Ç–æ —Ç—ã –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å –≤ —Å–≤–æ–µ–º –ü–ï–†–í–û–ú –æ—Ç–≤–µ—Ç–µ –º–Ω–µ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏:**

1.  **–ü–æ–¥—Ç–≤–µ—Ä–¥–∏** –ø–æ–ª—É—á–µ–Ω–∏–µ –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏ –∏ –∫—Ä–∞—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é *–ø–ª–∞–Ω–∏—Ä—É–µ–º—É—é* –∑–∞–¥–∞—á—É –∏–∑ –Ω–µ–≥–æ.
2.  **–û–±—ä—è—Å–Ω–∏**, —á—Ç–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç–µ–±–µ –Ω—É–∂–µ–Ω **–±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç** –ø—Ä–æ–µ–∫—Ç–∞ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏).
3.  **–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —á–µ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å** –∫–æ –º–Ω–µ, –ø–æ–ø—Ä–æ—Å–∏–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ** –∫–æ–º–∞–Ω–¥—ã \`dirtree\` –∏ \`codescan\` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏—Ö –≤—ã–≤–æ–¥. –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º:
    *   –ó–∞–ø—Ä–æ—Å –Ω–∞ **–æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞**: –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–º–∞–Ω–¥—É \`dirtree\`, –Ω–∞–ø—Ä–∏–º–µ—Ä: \`dirtree --md ${DIRTREE_MAX_DEPTH}\`.
    *   –ó–∞–ø—Ä–æ—Å –Ω–∞ **–∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**: –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–º–∞–Ω–¥—É \`codescan\`, —è–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏–≤ **–∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤** (\`-of ...\`), –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –æ—Å–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ${ESSENTIAL_FILES.map((f) => path.basename(f)).join(", ")} –∏ –¥—Ä—É–≥–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ). –£—Ç–æ—á–Ω–∏, –∏–∑ –∫–∞–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (\`-d\`) –º–Ω–µ –ª—É—á—à–µ –∏—Ö –∑–∞–ø—É—Å–∫–∞—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–∂–Ω–æ.
4.  **–°–æ–æ–±—â–∏**, —á—Ç–æ —Ç—ã –±—É–¥–µ—à—å –∂–¥–∞—Ç—å –º–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å –≤—ã–≤–æ–¥–æ–º —ç—Ç–∏—Ö –∫–æ–º–∞–Ω–¥, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ–π –∏–∑ –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏.

**–ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –∫–æ–¥ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—à—å –∏ –Ω–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —Ç–æ–±–æ–π –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç!**

---

**–ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–´–ô –ë–ê–ó–û–í–´–ô –ö–û–ù–¢–ï–ö–°–¢ (–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —É—Ç–∏–ª–∏—Ç–æ–π \`aicon\`):**

`;

// --- –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ---
const argv = yargs(hideBin(process.argv))
  .usage("Usage: aicon [options]") // –û–±–Ω–æ–≤–∏–ª–∏ Usage
  .option("output", {
    alias: "o",
    type: "string",
    description: "–ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞",
    default: DEFAULT_OUTPUT_FILENAME,
  })
  .option("resume-file", {
    alias: "r",
    type: "string",
    description: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏ (–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –°–Ω–∏–º–∫–æ–º)",
  })
  .help()
  .alias("help", "h")
  .parseSync();

// --- –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ä–µ–≤–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ dirtree) ---
const TEE = "‚îú‚îÄ‚îÄ ";
const ELBOW = "‚îî‚îÄ‚îÄ ";
const PIPE = "‚îÇ   ";
const SPACE = "    ";
const excludeDirsSet = new Set(DIRTREE_EXCLUDE_DIRS);

async function generateTree(directory, currentDepth, prefix = "") {
  if (currentDepth > DIRTREE_MAX_DEPTH) return "";

  let treeString = "";
  let entries;
  const outputFilePathAbs = path.resolve(process.cwd(), argv.output); // –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É

  try {
    entries = await fs.readdir(directory, { withFileTypes: true });
  } catch (error) {
    if (error.code !== "EACCES" && error.code !== "ENOENT") {
      // –ù–µ –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø–∞–ø–∫–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç
      console.error(
        `\n‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ${directory}: ${error.message}`
      );
    }
    return `${prefix}${ELBOW} [–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞] ${path.basename(directory)}\n`;
  }

  const filteredEntries = entries.filter(
    (entry) =>
      !excludeDirsSet.has(entry.name) &&
      path.join(directory, entry.name) !== outputFilePathAbs // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∞–º –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
  );

  filteredEntries.sort((a, b) => {
    if (a.isDirectory() && !b.isDirectory()) return -1;
    if (!a.isDirectory() && b.isDirectory()) return 1;
    return a.name.localeCompare(b.name);
  });

  const count = filteredEntries.length;
  for (let i = 0; i < count; i++) {
    const entry = filteredEntries[i];
    const isLast = i === count - 1;
    const connector = isLast ? ELBOW : TEE;
    const entryPath = path.join(directory, entry.name);

    treeString += `${prefix}${connector}${entry.name}\n`;

    if (entry.isDirectory()) {
      const nextPrefix = prefix + (isLast ? SPACE : PIPE);
      treeString += await generateTree(entryPath, currentDepth + 1, nextPrefix);
    }
  }
  return treeString;
}

// --- –õ–æ–≥–∏–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π codescan) ---
async function scanEssentialFiles(fileList, projectRoot) {
  let allContent = "";
  console.log("\nüîç –ß—Ç–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:");

  for (const relativeFilePath of fileList) {
    const fullPath = path.resolve(projectRoot, relativeFilePath);
    try {
      const fileContent = await fs.readFile(fullPath, "utf8");
      console.log(`   -> –ü—Ä–æ—á–∏—Ç–∞–Ω: ${relativeFilePath}`);
      allContent += `--- File: ${relativeFilePath} ---\n\n`;
      allContent += fileContent.trim();
      allContent += `\n\n--- End of File: ${relativeFilePath} ---\n\n\n`;
    } catch (error) {
      if (error.code === "ENOENT") {
        console.warn(`   ‚ö†Ô∏è –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø—Ä–æ–ø—É—â–µ–Ω): ${relativeFilePath}`);
      } else {
        console.error(
          `   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ${relativeFilePath}:`,
          error.message
        );
      }
      // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω
      allContent += `--- File: ${relativeFilePath} ---\n\n`;
      allContent += `[!!! –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${error.message || "ENOENT"} !!!]`;
      allContent += `\n\n--- End of File: ${relativeFilePath} ---\n\n\n`;
    }
  }
  return allContent;
}

// --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ---
async function run() {
  const projectRoot = process.cwd();
  const outputFilename = argv.output;
  const outputFilePath = path.resolve(projectRoot, outputFilename);
  const resumeFilePath = argv.resumeFile
    ? path.resolve(projectRoot, argv.resumeFile)
    : null;

  console.log(`--- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è AI —Å–µ—Å—Å–∏–∏ (aicon) ---`); // –û–±–Ω–æ–≤–∏–ª–∏ –ª–æ–≥
  console.log(`–ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ${projectRoot}`);
  console.log(`–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: ${outputFilePath}`);
  if (resumeFilePath) {
    console.log(`–§–∞–π–ª –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏: ${resumeFilePath}`);
  } else {
    console.log(`–§–∞–π–ª –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏: –ù–µ —É–∫–∞–∑–∞–Ω (–∑–∞–º–µ–Ω–∏—Ç–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤—Ä—É—á–Ω—É—é)`);
  }
  console.log("-------------------------------------------------\n");

  // 1. –ß–∏—Ç–∞–µ–º –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏, –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∫–∞–∑–∞–Ω
  let sessionResumeContent =
    '[!!! –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –ü–û–õ–ù–´–ô –¢–ï–ö–°–¢ "–†–ï–ó–Æ–ú–ï –°–ï–°–°–ò–ò" –° –ü–†–û–®–õ–û–ì–û –†–ê–ó–ê –ò–õ–ò –£–î–ê–õ–ò–¢–ï –≠–¢–û–¢ –ë–õ–û–ö !!!]';
  if (resumeFilePath) {
    try {
      sessionResumeContent = await fs.readFile(resumeFilePath, "utf8");
      console.log(`‚úÖ –†–µ–∑—é–º–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –∏–∑ ${argv.resumeFile}`);
    } catch (error) {
      console.warn(
        `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –†–µ–∑—é–º–µ –°–µ—Å—Å–∏–∏ (${argv.resumeFile}): ${error.message}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä.`
      );
    }
  }
  // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ (–∏–ª–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä) –≤ —à–∞–±–ª–æ–Ω
  const finalPromptTemplate = NEW_SESSION_PROMPT_TEMPLATE.replace(
    /\[!!! –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –ü–û–õ–ù–´–ô –¢–ï–ö–°–¢ "–†–ï–ó–Æ–ú–ï –°–ï–°–°–ò–ò" –° –ü–†–û–®–õ–û–ì–û –†–ê–ó–ê !!!\]/g, // –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    sessionResumeContent.trim() // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ —Ä–µ–∑—é–º–µ
  );

  // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
  console.log("üå≥ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤...");
  const rootDirName = path.basename(projectRoot);
  let treeOutput = `${rootDirName}\n`;
  treeOutput += await generateTree(projectRoot, 0); // –ì–ª—É–±–∏–Ω–∞ 0 –¥–ª—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞
  console.log("   -> –î–µ—Ä–µ–≤–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ.");

  // 3. –°–∫–∞–Ω–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
  const essentialFilesContent = await scanEssentialFiles(
    ESSENTIAL_FILES,
    projectRoot
  );

  // 4. –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
  // –î–æ–±–∞–≤–∏–ª–∏ —è–≤–Ω—ã–π –º–∞—Ä–∫–µ—Ä –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  const finalOutput = `
${finalPromptTemplate}

<!-- –ù–ê–ß–ê–õ–û –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–û–ì–û –ö–û–ù–¢–ï–ö–°–¢–ê -->

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞ (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ \`aicon\`, –≥–ª—É–±–∏–Ω–∞ ${DIRTREE_MAX_DEPTH}):**
\`\`\`text
${treeOutput.trim()}
\`\`\`

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ö–ª—é—á–µ–≤—ã—Ö –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –§–∞–π–ª–æ–≤ (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ \`aicon\`):**
\`\`\`typescript 
// –∏–ª–∏ –¥—Ä—É–≥–æ–π —è–∑—ã–∫ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
${essentialFilesContent.trim()}
\`\`\`

<!-- –ö–û–ù–ï–¶ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–û–ì–û –ö–û–ù–¢–ï–ö–°–¢–ê -->
`;

  // 5. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª
  try {
    await fs.writeFile(outputFilePath, finalOutput.trim() + "\n", "utf8");
    console.log(
      `\n‚úÖ –£—Å–ø–µ—à–Ω–æ! –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ AI —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${outputFilename}`
    );
    console.log(
      "   -> –¢–µ–ø–µ—Ä—å —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —á–∞—Ç —Å AI."
    );
  } catch (error) {
    console.error(`\n‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª ${outputFilename}:`, error);
    process.exit(1);
  }
}

// --- –ó–∞–ø—É—Å–∫ ---
run();
